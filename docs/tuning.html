<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>The R in Spark: Learning Apache Spark with R</title>
  <meta name="description" content="A book to learn Apache Spark with R using the sparklyr R package.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="The R in Spark: Learning Apache Spark with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A book to learn Apache Spark with R using the sparklyr R package." />
  <meta name="github-repo" content="javierluraschi/the-r-in-spark" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="The R in Spark: Learning Apache Spark with R" />
  
  <meta name="twitter:description" content="A book to learn Apache Spark with R using the sparklyr R package." />
  

<meta name="author" content="Javier Luraschi">


<meta name="date" content="2018-08-18">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="connections.html">
<link rel="next" href="data.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.2/htmlwidgets.js"></script>
<script src="libs/r2d3-render-0.1.0/r2d3-render.js"></script>
<script src="libs/webcomponents-2.0.0/webcomponents.js"></script>
<script src="libs/r2d3-binding-0.2.2/r2d3.js"></script>
<script src="libs/d3v5-5.0.0/d3.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#background"><i class="fa fa-check"></i><b>1.1</b> Background</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#spark"><i class="fa fa-check"></i><b>1.2</b> Spark</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#r"><i class="fa fa-check"></i><b>1.3</b> R</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#sparklyr"><i class="fa fa-check"></i><b>1.4</b> sparklyr</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="installation.html"><a href="installation.html"><i class="fa fa-check"></i><b>2</b> Installation</a><ul>
<li class="chapter" data-level="2.1" data-path="installation.html"><a href="installation.html#prerequisites"><i class="fa fa-check"></i><b>2.1</b> Prerequisites</a><ul>
<li class="chapter" data-level="2.1.1" data-path="installation.html"><a href="installation.html#install-r"><i class="fa fa-check"></i><b>2.1.1</b> Install R</a></li>
<li class="chapter" data-level="2.1.2" data-path="installation.html"><a href="installation.html#install-java"><i class="fa fa-check"></i><b>2.1.2</b> Install Java</a></li>
<li class="chapter" data-level="2.1.3" data-path="installation.html"><a href="installation.html#install-rstudio"><i class="fa fa-check"></i><b>2.1.3</b> Install RStudio</a></li>
<li class="chapter" data-level="2.1.4" data-path="installation.html"><a href="installation.html#install-sparklyr"><i class="fa fa-check"></i><b>2.1.4</b> Install sparklyr</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="installation.html"><a href="installation.html#installing-spark"><i class="fa fa-check"></i><b>2.2</b> Installing Spark</a></li>
<li class="chapter" data-level="2.3" data-path="installation.html"><a href="installation.html#connecting-to-spark"><i class="fa fa-check"></i><b>2.3</b> Connecting to Spark</a></li>
<li class="chapter" data-level="2.4" data-path="installation.html"><a href="installation.html#using-spark"><i class="fa fa-check"></i><b>2.4</b> Using Spark</a><ul>
<li class="chapter" data-level="2.4.1" data-path="installation.html"><a href="installation.html#spark-web-interface"><i class="fa fa-check"></i><b>2.4.1</b> Web Interface</a></li>
<li class="chapter" data-level="2.4.2" data-path="installation.html"><a href="installation.html#logs"><i class="fa fa-check"></i><b>2.4.2</b> Logs</a></li>
<li class="chapter" data-level="2.4.3" data-path="installation.html"><a href="installation.html#using-spark-from-rstudio"><i class="fa fa-check"></i><b>2.4.3</b> RStudio</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="installation.html"><a href="installation.html#disconnecting"><i class="fa fa-check"></i><b>2.5</b> Disconnecting</a></li>
<li class="chapter" data-level="2.6" data-path="installation.html"><a href="installation.html#recap"><i class="fa fa-check"></i><b>2.6</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="analysis.html"><a href="analysis.html"><i class="fa fa-check"></i><b>3</b> Analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="analysis.html"><a href="analysis.html#overview"><i class="fa fa-check"></i><b>3.1</b> Overview</a></li>
<li class="chapter" data-level="3.2" data-path="analysis.html"><a href="analysis.html#dplyr"><i class="fa fa-check"></i><b>3.2</b> dplyr</a></li>
<li class="chapter" data-level="3.3" data-path="analysis.html"><a href="analysis.html#dbi"><i class="fa fa-check"></i><b>3.3</b> DBI</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="modeling.html"><a href="modeling.html"><i class="fa fa-check"></i><b>4</b> Modeling</a><ul>
<li class="chapter" data-level="4.1" data-path="modeling.html"><a href="modeling.html#overview-1"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="modeling.html"><a href="modeling.html#supervised"><i class="fa fa-check"></i><b>4.2</b> Supervised</a></li>
<li class="chapter" data-level="4.3" data-path="modeling.html"><a href="modeling.html#unsupervised"><i class="fa fa-check"></i><b>4.3</b> Unsupervised</a><ul>
<li class="chapter" data-level="4.3.1" data-path="modeling.html"><a href="modeling.html#k-means-clustering"><i class="fa fa-check"></i><b>4.3.1</b> K-Means Clustering</a></li>
<li class="chapter" data-level="4.3.2" data-path="modeling.html"><a href="modeling.html#gaussian-mixture-clustering"><i class="fa fa-check"></i><b>4.3.2</b> Gaussian Mixture Clustering</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="modeling.html"><a href="modeling.html#broom"><i class="fa fa-check"></i><b>4.4</b> Broom</a></li>
<li class="chapter" data-level="4.5" data-path="modeling.html"><a href="modeling.html#pipelines"><i class="fa fa-check"></i><b>4.5</b> Pipelines</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="clusters.html"><a href="clusters.html"><i class="fa fa-check"></i><b>5</b> Clusters</a><ul>
<li class="chapter" data-level="5.1" data-path="clusters.html"><a href="clusters.html#overview-2"><i class="fa fa-check"></i><b>5.1</b> Overview</a></li>
<li class="chapter" data-level="5.2" data-path="clusters.html"><a href="clusters.html#managers"><i class="fa fa-check"></i><b>5.2</b> Managers</a><ul>
<li class="chapter" data-level="5.2.1" data-path="clusters.html"><a href="clusters.html#clusters-standalone"><i class="fa fa-check"></i><b>5.2.1</b> Standalone</a></li>
<li class="chapter" data-level="5.2.2" data-path="clusters.html"><a href="clusters.html#yarn"><i class="fa fa-check"></i><b>5.2.2</b> Yarn</a></li>
<li class="chapter" data-level="5.2.3" data-path="clusters.html"><a href="clusters.html#mesos"><i class="fa fa-check"></i><b>5.2.3</b> Mesos</a></li>
<li class="chapter" data-level="5.2.4" data-path="clusters.html"><a href="clusters.html#kubernetes"><i class="fa fa-check"></i><b>5.2.4</b> Kubernetes</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="clusters.html"><a href="clusters.html#on-premise"><i class="fa fa-check"></i><b>5.3</b> On-Premise</a><ul>
<li class="chapter" data-level="5.3.1" data-path="clusters.html"><a href="clusters.html#cloudera"><i class="fa fa-check"></i><b>5.3.1</b> Cloudera</a></li>
<li class="chapter" data-level="5.3.2" data-path="clusters.html"><a href="clusters.html#hortonworks"><i class="fa fa-check"></i><b>5.3.2</b> Hortonworks</a></li>
<li class="chapter" data-level="5.3.3" data-path="clusters.html"><a href="clusters.html#mapr"><i class="fa fa-check"></i><b>5.3.3</b> MapR</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="clusters.html"><a href="clusters.html#cloud"><i class="fa fa-check"></i><b>5.4</b> Cloud</a><ul>
<li class="chapter" data-level="5.4.1" data-path="clusters.html"><a href="clusters.html#amazon"><i class="fa fa-check"></i><b>5.4.1</b> Amazon</a></li>
<li class="chapter" data-level="5.4.2" data-path="clusters.html"><a href="clusters.html#google"><i class="fa fa-check"></i><b>5.4.2</b> Google</a></li>
<li class="chapter" data-level="5.4.3" data-path="clusters.html"><a href="clusters.html#microsoft"><i class="fa fa-check"></i><b>5.4.3</b> Microsoft</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="clusters.html"><a href="clusters.html#tools"><i class="fa fa-check"></i><b>5.5</b> Tools</a><ul>
<li class="chapter" data-level="5.5.1" data-path="clusters.html"><a href="clusters.html#rstudio"><i class="fa fa-check"></i><b>5.5.1</b> RStudio</a></li>
<li class="chapter" data-level="5.5.2" data-path="clusters.html"><a href="clusters.html#clusters-livy"><i class="fa fa-check"></i><b>5.5.2</b> Livy</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="clusters.html"><a href="clusters.html#recap-1"><i class="fa fa-check"></i><b>5.6</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="connections.html"><a href="connections.html"><i class="fa fa-check"></i><b>6</b> Connections</a><ul>
<li class="chapter" data-level="6.1" data-path="connections.html"><a href="connections.html#overview-3"><i class="fa fa-check"></i><b>6.1</b> Overview</a><ul>
<li class="chapter" data-level="6.1.1" data-path="connections.html"><a href="connections.html#edge-nodes"><i class="fa fa-check"></i><b>6.1.1</b> Edge Nodes</a></li>
<li class="chapter" data-level="6.1.2" data-path="connections.html"><a href="connections.html#spark-home"><i class="fa fa-check"></i><b>6.1.2</b> Spark Home</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="connections.html"><a href="connections.html#types"><i class="fa fa-check"></i><b>6.2</b> Types</a><ul>
<li class="chapter" data-level="6.2.1" data-path="connections.html"><a href="connections.html#local"><i class="fa fa-check"></i><b>6.2.1</b> Local</a></li>
<li class="chapter" data-level="6.2.2" data-path="connections.html"><a href="connections.html#standalone"><i class="fa fa-check"></i><b>6.2.2</b> Standalone</a></li>
<li class="chapter" data-level="6.2.3" data-path="connections.html"><a href="connections.html#yarn-1"><i class="fa fa-check"></i><b>6.2.3</b> Yarn</a></li>
<li class="chapter" data-level="6.2.4" data-path="connections.html"><a href="connections.html#livy"><i class="fa fa-check"></i><b>6.2.4</b> Livy</a></li>
<li class="chapter" data-level="6.2.5" data-path="connections.html"><a href="connections.html#mesos-1"><i class="fa fa-check"></i><b>6.2.5</b> Mesos</a></li>
<li class="chapter" data-level="6.2.6" data-path="connections.html"><a href="connections.html#kubernetes-1"><i class="fa fa-check"></i><b>6.2.6</b> Kubernetes</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="connections.html"><a href="connections.html#troubleshooting"><i class="fa fa-check"></i><b>6.3</b> Troubleshooting</a><ul>
<li class="chapter" data-level="6.3.1" data-path="connections.html"><a href="connections.html#logging"><i class="fa fa-check"></i><b>6.3.1</b> Logging</a></li>
<li class="chapter" data-level="6.3.2" data-path="connections.html"><a href="connections.html#troubleshoot-spark-submit"><i class="fa fa-check"></i><b>6.3.2</b> Spark Submit</a></li>
<li class="chapter" data-level="6.3.3" data-path="connections.html"><a href="connections.html#multiple"><i class="fa fa-check"></i><b>6.3.3</b> Multiple</a></li>
<li class="chapter" data-level="6.3.4" data-path="connections.html"><a href="connections.html#windows"><i class="fa fa-check"></i><b>6.3.4</b> Windows</a></li>
<li class="chapter" data-level="6.3.5" data-path="connections.html"><a href="connections.html#submit-manually"><i class="fa fa-check"></i><b>6.3.5</b> Submit Manually</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="connections.html"><a href="connections.html#recap-2"><i class="fa fa-check"></i><b>6.4</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="tuning.html"><a href="tuning.html"><i class="fa fa-check"></i><b>7</b> Tuning</a><ul>
<li class="chapter" data-level="7.1" data-path="tuning.html"><a href="tuning.html#overview-4"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
<li class="chapter" data-level="7.2" data-path="tuning.html"><a href="tuning.html#configuring"><i class="fa fa-check"></i><b>7.2</b> Configuring</a></li>
<li class="chapter" data-level="7.3" data-path="tuning.html"><a href="tuning.html#partitioning"><i class="fa fa-check"></i><b>7.3</b> Partitioning</a><ul>
<li class="chapter" data-level="7.3.1" data-path="tuning.html"><a href="tuning.html#implicit"><i class="fa fa-check"></i><b>7.3.1</b> Implicit</a></li>
<li class="chapter" data-level="7.3.2" data-path="tuning.html"><a href="tuning.html#explicit"><i class="fa fa-check"></i><b>7.3.2</b> Explicit</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="tuning.html"><a href="tuning.html#caching"><i class="fa fa-check"></i><b>7.4</b> Caching</a><ul>
<li class="chapter" data-level="7.4.1" data-path="tuning.html"><a href="tuning.html#memory"><i class="fa fa-check"></i><b>7.4.1</b> Memory</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="tuning.html"><a href="tuning.html#shuffling"><i class="fa fa-check"></i><b>7.5</b> Shuffling</a></li>
<li class="chapter" data-level="7.6" data-path="tuning.html"><a href="tuning.html#troubleshooting-1"><i class="fa fa-check"></i><b>7.6</b> Troubleshooting</a><ul>
<li class="chapter" data-level="7.6.1" data-path="tuning.html"><a href="tuning.html#graph-visualization"><i class="fa fa-check"></i><b>7.6.1</b> Graph Visualization</a></li>
<li class="chapter" data-level="7.6.2" data-path="tuning.html"><a href="tuning.html#event-timeline"><i class="fa fa-check"></i><b>7.6.2</b> Event Timeline</a></li>
<li class="chapter" data-level="7.6.3" data-path="tuning.html"><a href="tuning.html#checkpointing"><i class="fa fa-check"></i><b>7.6.3</b> Checkpointing</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="tuning.html"><a href="tuning.html#recap-3"><i class="fa fa-check"></i><b>7.7</b> Recap</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>8</b> Data</a><ul>
<li class="chapter" data-level="8.1" data-path="data.html"><a href="data.html#overview-5"><i class="fa fa-check"></i><b>8.1</b> Overview</a></li>
<li class="chapter" data-level="8.2" data-path="data.html"><a href="data.html#formats"><i class="fa fa-check"></i><b>8.2</b> Formats</a></li>
<li class="chapter" data-level="8.3" data-path="data.html"><a href="data.html#external"><i class="fa fa-check"></i><b>8.3</b> External</a><ul>
<li class="chapter" data-level="8.3.1" data-path="data.html"><a href="data.html#cassandra"><i class="fa fa-check"></i><b>8.3.1</b> Cassandra</a></li>
<li class="chapter" data-level="8.3.2" data-path="data.html"><a href="data.html#databases"><i class="fa fa-check"></i><b>8.3.2</b> Databases</a></li>
<li class="chapter" data-level="8.3.3" data-path="data.html"><a href="data.html#hbase"><i class="fa fa-check"></i><b>8.3.3</b> HBase</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="data.html"><a href="data.html#troubleshooting-2"><i class="fa fa-check"></i><b>8.4</b> Troubleshooting</a><ul>
<li class="chapter" data-level="8.4.1" data-path="data.html"><a href="data.html#troubleshoot-csvs"><i class="fa fa-check"></i><b>8.4.1</b> Troubleshoot CSVs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="extensions.html"><a href="extensions.html"><i class="fa fa-check"></i><b>9</b> Extensions</a><ul>
<li class="chapter" data-level="9.1" data-path="extensions.html"><a href="extensions.html#using-extensions"><i class="fa fa-check"></i><b>9.1</b> Using Extensions</a><ul>
<li class="chapter" data-level="9.1.1" data-path="extensions.html"><a href="extensions.html#rsparkling"><i class="fa fa-check"></i><b>9.1.1</b> RSparkling</a></li>
<li class="chapter" data-level="9.1.2" data-path="extensions.html"><a href="extensions.html#graphframes"><i class="fa fa-check"></i><b>9.1.2</b> GraphFrames</a></li>
<li class="chapter" data-level="9.1.3" data-path="extensions.html"><a href="extensions.html#mleap"><i class="fa fa-check"></i><b>9.1.3</b> Mleap</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="extensions.html"><a href="extensions.html#writting-extensions"><i class="fa fa-check"></i><b>9.2</b> Writting Extensions</a><ul>
<li class="chapter" data-level="9.2.1" data-path="extensions.html"><a href="extensions.html#rstudio-projects"><i class="fa fa-check"></i><b>9.2.1</b> RStudio Projects</a></li>
<li class="chapter" data-level="9.2.2" data-path="extensions.html"><a href="extensions.html#troubleshooting-3"><i class="fa fa-check"></i><b>9.2.2</b> Troubleshooting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="distributed.html"><a href="distributed.html"><i class="fa fa-check"></i><b>10</b> Distributed R</a><ul>
<li class="chapter" data-level="10.1" data-path="distributed.html"><a href="distributed.html#use-cases"><i class="fa fa-check"></i><b>10.1</b> Use Cases</a></li>
<li class="chapter" data-level="10.2" data-path="distributed.html"><a href="distributed.html#grouping"><i class="fa fa-check"></i><b>10.2</b> Grouping</a></li>
<li class="chapter" data-level="10.3" data-path="distributed.html"><a href="distributed.html#packages"><i class="fa fa-check"></i><b>10.3</b> Packages</a></li>
<li class="chapter" data-level="10.4" data-path="distributed.html"><a href="distributed.html#restrictions"><i class="fa fa-check"></i><b>10.4</b> Restrictions</a></li>
<li class="chapter" data-level="10.5" data-path="distributed.html"><a href="distributed.html#troubleshooting-4"><i class="fa fa-check"></i><b>10.5</b> Troubleshooting</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="streaming.html"><a href="streaming.html"><i class="fa fa-check"></i><b>11</b> Streaming</a><ul>
<li class="chapter" data-level="11.1" data-path="streaming.html"><a href="streaming.html#overview-6"><i class="fa fa-check"></i><b>11.1</b> Overview</a></li>
<li class="chapter" data-level="11.2" data-path="streaming.html"><a href="streaming.html#transformations"><i class="fa fa-check"></i><b>11.2</b> Transformations</a><ul>
<li class="chapter" data-level="11.2.1" data-path="streaming.html"><a href="streaming.html#streams-dplyr"><i class="fa fa-check"></i><b>11.2.1</b> dplyr</a></li>
<li class="chapter" data-level="11.2.2" data-path="streaming.html"><a href="streaming.html#streams-pipelines"><i class="fa fa-check"></i><b>11.2.2</b> Pipelines</a></li>
<li class="chapter" data-level="11.2.3" data-path="streaming.html"><a href="streaming.html#streams-r"><i class="fa fa-check"></i><b>11.2.3</b> R Code</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="streaming.html"><a href="streaming.html#shiny"><i class="fa fa-check"></i><b>11.3</b> Shiny</a></li>
<li class="chapter" data-level="11.4" data-path="streaming.html"><a href="streaming.html#formats-1"><i class="fa fa-check"></i><b>11.4</b> Formats</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="contributing.html"><a href="contributing.html"><i class="fa fa-check"></i><b>12</b> Contributing</a><ul>
<li class="chapter" data-level="12.1" data-path="contributing.html"><a href="contributing.html#overview-7"><i class="fa fa-check"></i><b>12.1</b> Overview</a></li>
<li class="chapter" data-level="12.2" data-path="contributing.html"><a href="contributing.html#serialization"><i class="fa fa-check"></i><b>12.2</b> Serialization</a></li>
<li class="chapter" data-level="12.3" data-path="contributing.html"><a href="contributing.html#invocations"><i class="fa fa-check"></i><b>12.3</b> Invocations</a></li>
<li class="chapter" data-level="12.4" data-path="contributing.html"><a href="contributing.html#r-packages"><i class="fa fa-check"></i><b>12.4</b> R Packages</a></li>
<li class="chapter" data-level="12.5" data-path="contributing.html"><a href="contributing.html#connections-1"><i class="fa fa-check"></i><b>12.5</b> Connections</a></li>
<li class="chapter" data-level="12.6" data-path="contributing.html"><a href="contributing.html#distributed-r"><i class="fa fa-check"></i><b>12.6</b> Distributed R</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i>Appendix</a><ul>
<li class="chapter" data-level="12.7" data-path="appendix.html"><a href="appendix.html#storage-capacity"><i class="fa fa-check"></i><b>12.7</b> Worlds Store Capacity</a></li>
<li class="chapter" data-level="12.8" data-path="appendix.html"><a href="appendix.html#cran-downloads"><i class="fa fa-check"></i><b>12.8</b> Daily downloads of CRAN packages</a></li>
<li class="chapter" data-level="12.9" data-path="appendix.html"><a href="appendix.html#cluster-trends"><i class="fa fa-check"></i><b>12.9</b> Google trends for mainframes, cloud computing and kubernetes</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The R in Spark: Learning Apache Spark with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tuning" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Tuning</h1>
<p>Previous chapters focused on installing, using and connecting to Spark clusters, we’ve assumed so far that computation in a Spark cluster works. While this is true in many cases, it is often required to have some knowledge of how Spark internally. This with the purpose of tunning resources and operations to run larger datasets in Spark. This chapter will explain how Spark works and provide details on how to tune its operations.</p>
<div id="overview-4" class="section level2">
<h2><span class="header-section-number">7.1</span> Overview</h2>
<p>Spark performs distributed computation by: configuring cluster resources and partitioning, executing, shuffling and caching data across many machines:</p>
<ul>
<li><strong>Configuring</strong> means asking the cluster manager how many machines, memory, CPUs, etc. will be needed.</li>
<li><strong>Partitioning</strong> means splitting data among various machines, partitions can be either implicit or explicit.</li>
<li><strong>Executing</strong> means running an arbitrary transformation over each partition.</li>
<li><strong>Shuffling</strong> redistributes data when data to the correct machine.</li>
<li><strong>Caching</strong> preserves data in-memory across other computation cycles.</li>
</ul>
<p>The following diagram shows an example on how sorting would conceptually work across a cluster of machines. First, Spark would <strong>configure</strong> the cluster to use three worker machines. In this example, the numbers 1-9 are partitioned across three storage instances. Since the data is already partitioned, each worker node loads this implicit <strong>partition</strong>; for instance, <code>4,9,1</code> is loaded in the first worker node. Afterwards, a custom transformation is applied to each partition in each worker node, this is denoted by <code>f(x)</code> in the diagram bellow. In this example, <code>f(x)</code> <strong>executes</strong> a sorting operation over the numbers within a partition. Since Spark is general, execution over a partition can be as simple or sophisticated as needed. Once the execution completes, the result is <strong>shuffled</strong> to the right machine to finish the sorting operation across the entire dataset. Finally, once the data is sorted across the cluster, the sorted results can be optionally <strong>cached</strong> in memory to avoid rerunning this computation multiple times.</p>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-1"></span>
<div id="htmlwidget-41dc0025f47574dc503b" style="width:100%;height:480px;" class="r2d3 html-widget"></div>
<script type="application/json" data-for="htmlwidget-41dc0025f47574dc503b">{"x":{"data":null,"type":"NULL","container":"svg","options":null,"script":"var d3Script = function(d3, r2d3, data, svg, width, height, options, theme, console) {\nthis.d3 = d3;\n/* R2D3 Source File:  images/06-connections-diagram.js */\n\nsvg.append(\"svg:defs\").append(\"svg:marker\")\n  .attr(\"id\", \"circle\")\n  .attr(\"refX\", 6)\n  .attr(\"refY\", 6)\n  .attr(\"markerWidth\", 12)\n  .attr(\"markerHeight\", 12)\n  .attr(\"orient\", \"auto\")\n  .append(\"circle\")\n  .attr(\"cx\", \"6\")\n  .attr(\"cy\", \"6\")\n  .attr(\"r\", \"3\")\n  .attr(\"class\", \"block-link\")\n  .attr(\"stroke-width\", 1);\n\nfunction diagramRoot(maxWidth) {\n  if (!maxWidth) maxWidth = 500;\n\n  var scaleX = 1;\n  var scaleY = 1;\n  height = height - 20;\n\n  var newWidth = width > maxWidth ? maxWidth : width;\n  var translateX = width > newWidth ? (width - newWidth) / 2 : 0;\n  var translateY = 10;\n  width = newWidth;\n\n  svg\n    .attr(\"font-size\", Math.min(width, 500) / 600 + \"em\")\n    .attr(\"font-family\", \"sans-serif\");\n\n  var root = svg.append(\"g\")\n    .attr(\"transform\", \"translate(\" + translateX + \",\" + translateY + \")scale(\" + scaleX + \",\" + scaleY + \")\");\n\n  return root;\n}\n\nfunction drawBlock(parent, block) {\n  if (!block.x) block.x = 0;\n  if (!block.y) block.y = 0;\n  if (!block.width) block.width = blockWidth;\n  if (!block.height) block.height = blockHeight;\n  if (!block.color) block.color = \"#bbcce0\";\n  if (!block.label) block.label = \"<label>\";\n  if (!block.style) block.style = \"block\";\n\n  var startX = block.x - block.width / 2;\n  var startY = block.y - block.height / 2;\n\n  parent.append(\"rect\")\n    .attr(\"x\", startX)\n    .attr(\"y\", startY)\n    .attr(\"width\", block.width)\n    .attr(\"height\", block.height)\n    .attr(\"class\", block.style);\n\n  var current = parent.append(\"text\")\n    .attr(\"x\", block.x)\n    .attr(\"y\", startY + 20)\n    .attr(\"fill\", \"white\")\n    .attr(\"text-anchor\", \"middle\")\n    .text(block.label);\n\n  if (block.childrens) {\n    for (var childIdx in block.childrens) {\n      var child = block.childrens[childIdx];\n\n      if (!child.width) child.width = block.width - 20;\n      if (!child.x) child.x = block.x;\n      if (child.position === undefined) child.position = childIdx;\n      if (child.style === undefined) child.style = \"block-children\";\n\n      var childBlock = {\n        x: child.x,\n        y: startY + 46 + child.position * 34,\n        width: child.width,\n        height: 30,\n        label: child.label,\n        style: child.style\n      };\n\n      drawBlock(parent, childBlock);\n    }\n  }\n\n  return block;\n}\n\nfunction linkBlocks(block1, block2, label) {\n  var block1right = block1.x + block1.width / 2;\n  var block2left = block2.x - block2.width / 2;\n  var block1bottom = block1.y + block1.height / 2;\n  var block2top = block2.y - block2.height / 2;\n\n  var horizontal = block1right < block2left;\n\n  root.append('line')\n    .attr(\"x1\", horizontal ? block1right : block1.x)\n    .attr(\"y1\", horizontal ? block1.y : block1bottom)\n    .attr(\"x2\", horizontal ? block2left : block2.x)\n    .attr(\"y2\", horizontal ? block2.y : block2top)\n  \t.attr(\"class\", \"block-link\")\n  \t.attr(\"stroke-width\", \"1\")\n  \t.attr(\"marker-start\", \"url(#circle)\")\n  \t.attr(\"marker-end\", \"url(#circle)\")\n  \t.attr(\"stroke-dasharray\", \"3,7\");\n\n  var labelFits = horizontal ?\n    Math.abs(block2left - block1right) > block1.width / 2 :\n    Math.abs(block2top - block1bottom) > 30;\n\n  if (label && labelFits) {\n    root.append('text')\n      .attr(\"dy\", (horizontal ? \"-\" : \"\") + \"0.4em\")\n      .attr(\"x\", block1right + (block2left - block1right) / 2)\n      .attr(\"y\", block1bottom + (block2top - block1bottom) / 2)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"fill\", \"#759cc7\")\n      .text(label);\n  }\n}\nsvg = d3.select(svg.node());\n/* R2D3 Source File:  images/07-tuning-spark-overview.js */\n// !preview r2d3 dependencies=\"images/06-connections-diagram.js\", css=\"images/07-tuning-spark-overview.css\"\n//\n// r2d3: https://rstudio.github.io/r2d3\n//\n\nvar root = diagramRoot(600);\nvar blockWidth = width / 7.0;\n\nvar totalWorkers = 3;\nvar blockHeight = height / totalWorkers - 10;\n\nvar stages = [\n  [\n    [4, 9, 1],\n    [8, 2, 3],\n    [5, 7, 6]\n  ],\n  [\n    [1, 4, 9],\n    [2, 3, 8],\n    [5, 6, 7]\n  ],\n  [\n    [1, 2, 3],\n    [4, 5, 6],\n    [7, 8, 9]\n  ]\n];\n\nvar storageBlocks = new Array(totalWorkers);\nfor (var i = 0; i < totalWorkers; i++) {\n  var children = new Array(stages[0][i].length);\n  for (var j = 0; j < children.length; j++) {\n    children[j] = {\n      label: stages[0][i][j],\n      width: blockWidth - 40,\n      style: \"block-data-children\"\n    };\n  }\n\n  storageBlocks[i] = drawBlock(root, {\n    x: blockWidth / 2,\n    y: 5 + blockHeight / 2 + height / totalWorkers * i,\n    width: blockWidth * 0.8,\n    height: blockHeight,\n    label: \"Data\",\n    childrens: children,\n    style: \"block-data\"\n  });\n}\n\nvar stage1 = new Array(totalWorkers);\nfor (var i = 0; i < totalWorkers; i++) {\n  var children = new Array(stages[0][0].length + stages[1][0].length + 1);\n  for (var j = 0; j < stages[0][0].length; j++) {\n    children[j] = {\n      label: stages[0][i][j],\n      width: blockWidth - 40,\n      x: blockWidth * (2 - 1 / 2),\n      position: j\n    };\n  }\n\n  children[children.length - 1] = {\n    label: \"f(x)\",\n    width: blockWidth * 0.7 - 40,\n    style: \"block-data-children\",\n    position: 1\n  };\n\n  for (var j = 0; j < stages[1][0].length; j++) {\n    children[j + stages[0][0].length] = {\n      label: stages[1][i][j],\n      width: blockWidth - 40,\n      x: blockWidth * (2 + 1 / 2),\n      position: j\n    };\n  }\n\n  stage1[i] = drawBlock(root, {\n    x: blockWidth * (2),\n    y: 5 + blockHeight / 2 + height / totalWorkers * i,\n    width: blockWidth * 2,\n    height: blockHeight,\n    label: \"Worker\",\n    childrens: children\n  });\n}\n\nvar stage2 = new Array(totalWorkers);\nfor (var i = 0; i < totalWorkers; i++) {\n  var children = new Array(stages[2][i].length);\n  for (var j = 0; j < children.length; j++) {\n    children[j] = {\n      label: stages[2][i][j],\n      width: blockWidth - 40,\n      x: blockWidth * (7 - 1 / 2)\n    };\n  }\n\n  stage2[i] = drawBlock(root, {\n    x: blockWidth * (7 - 1/2),\n    y: 5 + blockHeight / 2 + height / totalWorkers * i,\n    width: blockWidth,\n    height: blockHeight,\n    label: \"Worker\",\n    childrens: children\n  });\n}\n\nfor (var i = 0; i < stage1.length; i++) {\n  for (var j = 0; j < stage2.length; j++) {\n    linkBlocks(stage1[i], stage2[j]);\n  }\n}\n};","style":"/* R2D3 Source File:  images/07-tuning-spark-overview.css */\n.block {\n  fill: #bbcce0;\n}\n\n.block-data {\n  fill: #e0e0f0;\n}\n\n.block-children {\n  fill: #93acc7;\n}\n\n.block-data-children {\n  fill: #bbcce0;\n}\n\n.block-link {\n  fill: white;\n  stroke: #bbcce0;\n}","version":5,"theme":{"default":{"background":"#FFFFFF","foreground":"#000000"},"runtime":null},"useShadow":true},"evals":[],"jsHooks":[]}</script>
<p class="caption">
FIGURE 7.1: Spark Overview
</p>
</div>
<p>Notice that while the diagram above describes a sorting operation, a similar approach applies to filtering or joining datasets and analyzing and modeling data at scale. Spark provides support to perform custom partitions, custom shuffling, etc; however, these lower level operations are not exposed in <code>sparklyr</code> since they are provided by the data <a href="analysis.html#analysis">analysis</a> tools like <a href="streaming.html#streams-dplyr">dplyr</a> or <a href="analysis.html#dbi">DBI</a>. However, one can always use the Spark’s Scala API or run custom R code as the <a href="extensions.html#extensions">extensions</a> chapter will describe.</p>
</div>
<div id="configuring" class="section level2">
<h2><span class="header-section-number">7.2</span> Configuring</h2>
<p>When tuning a Spark application, consider defining a configuration specification to describe the resources your application needs to successfully need at scale.</p>
<p>Some of the most obvious resources you would want to define are:</p>
<ul>
<li>Number of workers. This is somewhat equivalent to number the number of CPUs you are requesting.</li>
<li>Memory per worker.</li>
</ul>
<p>Notice that some of these settings are different between <a href="clusters.html#clusters">clusters</a> and therefore, one often needs to research online what each cluster manager expects to configure Spark properly.</p>
<p>To list all the default settings, we can run the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">spark_context_config</span>(sc)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">spark_session_config</span>(sc)</a></code></pre></div>
<p>See also: [<a href="https://spark.apache.org/docs/latest/configuration.html" class="uri">https://spark.apache.org/docs/latest/configuration.html</a>].</p>
</div>
<div id="partitioning" class="section level2">
<h2><span class="header-section-number">7.3</span> Partitioning</h2>
<div id="implicit" class="section level3">
<h3><span class="header-section-number">7.3.1</span> Implicit</h3>
</div>
<div id="explicit" class="section level3">
<h3><span class="header-section-number">7.3.2</span> Explicit</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a></code></pre></div>
<p>A first attempt to sort a large dataset in Spark would be to run:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Attempt to sort 20 GB dataset in disk with one billion entries</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">sdf_len</span>(sc, <span class="dv">10</span><span class="op">^</span><span class="dv">9</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x =</span> <span class="kw">rand</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="st">  </span><span class="kw">arrange</span>(x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="st">  </span><span class="kw">spark_write_csv</span>(<span class="st">&quot;billion.csv&quot;</span>)</a></code></pre></div>
<p>However, since each partition needs to fit in memory in Spark, the code above will result in an <code>OutOfMemory</code> exception that shuts down Spark completely. Instead, we can explicitly partition the data into chunks that would fit in the default memory configureation by explicitly defining the total number of partitions to use with the <code>repartition</code> parameter set to 10,000 as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># Sort 20 GB dataset in disk with one billion entries</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">sdf_len</span>(sc, <span class="dv">10</span><span class="op">^</span><span class="dv">9</span>, <span class="dt">repartition =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">4</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x =</span> <span class="kw">rand</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="st">  </span><span class="kw">arrange</span>(x) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="st">  </span><span class="kw">spark_write_csv</span>(<span class="st">&quot;billion.csv&quot;</span>)</a></code></pre></div>
</div>
</div>
<div id="caching" class="section level2">
<h2><span class="header-section-number">7.4</span> Caching</h2>
<p>From the <a href="Intro">introduction</a> chapter, we know that Spark was designed to be faster than it’s predecesors by using memory instead of disk to store data, this is formally known as an Spark <strong>RDD</strong> and stands for resilient distributed dataset. An RDD is resilient by duplicating copies of the same data across many machines, such that, if one machine fails other can complete the task. Resiliency is important in distributed systems since, while things will usually work in one machine, when running over thousands of machines the likelyhood of something failing is much higher; when a failure happens, it is prefferable be fault tolerant to avoid loosing the work of all the other machines. RDDs are fault tolerant by tracking data lineage information to rebuild lost data automatically on failure.</p>
<p>In <code>sparklyr</code>, you can control when an RDD gets loaded or unloaded from memory using <code>tbl_cache()</code> and <code>tbl_uncache()</code>.</p>
<p>Most sparklyr operations that retrieve a Spark data frame, cache the results in-memory, for instance, running <code>spark_read_parquet()</code> or <code>sdf_copy_to()</code> will provide a Spark dataframe that is already cached in-memory. As a Spark data frame, this object can be used in most sparklyr functions, including data analysis with dplyr or machine learning.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(sparklyr)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">sc &lt;-<span class="st"> </span><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">iris_tbl &lt;-<span class="st"> </span><span class="kw">sdf_copy_to</span>(sc, iris, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>You can inspect which tables are cached by navigating to the Spark UI using <code>spark_web(sc)</code>, opening the storage tab, and clicking on a given RDD:</p>
<div class="figure" style="text-align: center"><span id="fig:spark-standalone-rdd-web"></span>
<img src="images/07-tuning-cache-rdd-web.png" alt="Cached RDD in Spark Web Interface." width="496" />
<p class="caption">
FIGURE 7.2: Cached RDD in Spark Web Interface.
</p>
</div>
<p>Data loaded in memory will be released when the R session terminates either explicitly or implicitly with a restart or disconnection; however, to free up resources, you can use <code>tbl_uncache()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">tbl_uncache</span>(sc, <span class="st">&quot;iris&quot;</span>)</a></code></pre></div>
<div id="memory" class="section level3">
<h3><span class="header-section-number">7.4.1</span> Memory</h3>
<p>Memory in Spark is categorized into: <strong>reserved</strong>, <strong>user</strong>, <strong>excecution</strong> or <strong>storage</strong>.</p>
<p>As part of tuning execution, you can consider tweaking the amount of memory allocated for <strong>user</strong>, <strong>execution</strong> and <strong>storage</strong> by creating a Spark connection with different values that the defaults provided in Spark:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co"># define memory available for storage and excecution</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">config<span class="op">$</span>spark.memory.fraction &lt;-<span class="st"> </span><span class="fl">0.75</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co"># define memory available for storage</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">config<span class="op">$</span>spark.memory.storageFraction &lt;-<span class="st"> </span><span class="fl">0.5</span></a></code></pre></div>
<p>For instance, if you want to use Spark to store large amounts of data in-memory with the purpuse of filtering and retrieving subsets quickly, you can expect Spark to use little execution or user memoty; therefore, to maximize storage memory, one can tune Spark as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">config &lt;-<span class="st"> </span><span class="kw">spark_config</span>()</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># define memory available for storage and excecution</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">config<span class="op">$</span>spark.memory.fraction &lt;-<span class="st"> </span><span class="fl">0.90</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># define memory available for storage</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">config<span class="op">$</span>spark.memory.storageFraction &lt;-<span class="st"> </span><span class="fl">0.90</span></a></code></pre></div>
</div>
</div>
<div id="shuffling" class="section level2">
<h2><span class="header-section-number">7.5</span> Shuffling</h2>
</div>
<div id="troubleshooting-1" class="section level2">
<h2><span class="header-section-number">7.6</span> Troubleshooting</h2>
<div id="graph-visualization" class="section level3">
<h3><span class="header-section-number">7.6.1</span> Graph Visualization</h3>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-14"></span>
<img src="images/07-tuning-spark-graph-visualization.png" alt="Spark Graph Visualization" width="476" />
<p class="caption">
FIGURE 7.3: Spark Graph Visualization
</p>
</div>
</div>
<div id="event-timeline" class="section level3">
<h3><span class="header-section-number">7.6.2</span> Event Timeline</h3>
<p>One of the best ways to tune your Spark jobs is to use the Spark’s <a href="spark-web-interface">web interface</a>, click on the job being diagnosed, then the stage and then expand the <strong>event timeline</strong>.</p>
<p>Lets the take a look at the event timeline for the ordering a data frame by a given column using three partitions:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">spark_connect</span>(<span class="dt">master =</span> <span class="st">&quot;local&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="st">  </span><span class="kw">copy_to</span>(iris, <span class="dt">repartition =</span> <span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">  </span><span class="kw">arrange</span>(Sepal_Width)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-18"></span>
<img src="images/07-tuning-spark-event-timeline.png" alt="Spark Event Timeline" width="90%" />
<p class="caption">
FIGURE 7.4: Spark Event Timeline
</p>
</div>
</div>
<div id="checkpointing" class="section level3">
<h3><span class="header-section-number">7.6.3</span> Checkpointing</h3>
<p>When performing expensive computations, it can make sense to checkpoint your data. Meaning, you save the intermediate result to a distributed file system like HDFS.</p>
<p>You can checkpoint explicitly by saving to CSV, Parquet, etc. files. Or let Spark checkpoint this for you using <code>sdf_checkpoint()</code> in <code>sparklyr</code> as follows.</p>
<p>Notice that checkpointing truncates the computation lineage graph which can speed up performance if the same intermediate result is used multiple times.</p>
</div>
</div>
<div id="recap-3" class="section level2">
<h2><span class="header-section-number">7.7</span> Recap</h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="connections.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["the-r-in-spark.pdf", "the-r-in-spark.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
